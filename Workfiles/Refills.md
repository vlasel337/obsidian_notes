Промпт
```Markdown
Есть сервис по выдаче кредитов, внутри которого есть следующие функциональные блоки (идут по порядку):

1. Лэндинг (на этом наге клиент видит термзы оффера и может принять решение о начале прохождения ориджинейшена для получения займа) 
2. Ориджинейшен пользователя (в ходе которого клиент заполняет ряд экранов: CURP&RFC, address, email, банковские реквизиты своего счета своими персональными данные) 
3. Внутри origination также проводится процедура KYC между шагами с вводом адреса и шагом ввода банковских реквизитов, хочется отдельно тречить это состояние 
4. Подписание контракта после завершения ориджинейшена 
5. Шаг пэйаута, на котором клиенту отправляются средства на банковские реквизиты, которые он вввел 

Хочется организовать для этого флоу event-driven модель, чтобы при переходе на каждый из шагов в отдельной таблице state с пользовательским состоянием обновлялся stage пользователя, на котором он сейчас находится. Можешь предложить подходящую архитектуру для такого требования? А также обосновать ее плюсы и минусы
```


DDL таблицы user_state

```sql
CREATE TABLE user_state (
    application_id   UUID PRIMARY KEY,          -- идентификатор заявки
    user_id          UUID NOT NULL,             -- идентификатор пользователя
    stage            VARCHAR(50) NOT NULL,      -- основная стадия: LANDING, ORIGINATION, KYC, CONTRACT, PAYOUT, PAID, FAILED
    substate         JSONB,                     -- прогресс по шагам внутри стадии (например, какие экраны пройдены, статус KYC)
    last_event_id    UUID NOT NULL,             -- последний обработанный event_id (для идемпотентности)
    version          BIGINT DEFAULT 0 NOT NULL, -- оптимистичная блокировка (versioning)
    updated_at       TIMESTAMP NOT NULL
);
```

Атрибут `last_event_id` добавлен для того, чтобы соблюдалась идемпотентность (состояние системы при повторной обработке не менялось). Что-то типа предохранителя от повторной обработки. 

Хотим добавить флаг pending

Мы не хотим добавить в табличку state атрибут previous_event_id, чтобы иметь возможность быстро понимать какой шаг был предыдущим и в случае чего возвращаться на него? Плюс в случае, если что-то отвалится, этот атрибут позволит соблюсти идемпотентность (чтобы случайно не сделать несколько пэйаутов или не наплодить несколько контрактов)

