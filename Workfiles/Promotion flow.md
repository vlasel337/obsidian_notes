Актуальная статусная модель промоушенов:
https://indriver.atlassian.net/wiki/spaces/FINTECH/pages/2104459462/User+Promotion+status+model


Есть таблица с промоушеном в ней 1 

1. Скоринг готовит пре-оффера для новичков (`pre_offer`).
2. Клиента из новичковского сегмента получает новичковский сплит.
3. При переходе на лендинг клиент видит промо окно, в котором он может начать промоушен.
4. Клиент начинает промо. Создается запись в promotion_user.
5. Когда кладем reward в promotion_user



Сценарии:
1. Выполнил промо (за 14 дней).
2. Не выполнил промо.
3. Забрал награду вовремя.
4. Не забрал награду вовремя (за 7 дней).

Существует таблица `promotion`, в которой содержатся условия промоушена: таргетное кол-во поездок, минимальная сумма поездки, срок промоушена и прочие условия (по атрибуту `conditions`). В таблице `promotion` есть вербальный идентификатор промоушена, которые записан по атрибуту `promotion_key`.

При заборе офферов из gBQ через **user-info** сервис в таблицу `pre_offer` сервиса **credit-card** происходит проверка на наличие у пре-оффера `promotion_key` соответствующего тому, который есть в таблице `promotion`. 

Если ключ совпадает, то:
1. по нему маппится идентификатор промоушена из таблицы promotion,
2. после чего этот идентификатор записывается по атрибуту `promotion_id` таблицы `pre_offer`.

В момент сплитования клиента проверяется:
1. наличие у клиента пре-оффера на займ для новичков,
2. факт заполнения атрибута `promotion_id`,
3. в **geo-config** флаг, разрешающий проведение промоушенов, включен, 
4. клиент ранее не инициировал ориджинейшен по офферу, полученному в результате выполнения челленджа, то есть в таблице `promotion_user` у клиента нет записи со статусом '**REWARDED**' ([подробнее о статусной модели](https://indriver.atlassian.net/wiki/spaces/FINTECH/pages/2104459462/User+Promotion+status+model)).

При удовлетворении всех вышеописанных условий клиента сплитует на промо экран, в таблице `cash_loan_account` создается запись.

После того, как клиент решает принять участие в промо путем нажатия на кнопку '**Get started**' на BE выполняются следующие действия:
- проверяется, что по пре-офферу клиента в таблице `pre-offer` заполнен атрибут `promotion_id`,
- заполняется JSON атрибут `reward` таблицы `promotion_user`:  `{"product_id": 80, "amount_cents": 100000, "currency_code": "MXN", "repayment_rate": "15"}`.

После того, как клиент выполняет челлендж промоушена у него на FE появляется экран "Your MX$1,000 loan is ready!", информирующий клиента о том, что ему доступна награда – оффер на новичковский займ. 

Когда клиент нажимает на этом экране кнопку '**Continue**', FE дергает ручку `/get_reward`, которая подтягивает термзы оффера и показывает их на соответствующем экране.

Если клиенту нравятся условия, он вновь нажимает на кнопку '**Continue**' после чего дергается ручка `/accept_reward`, и на BE запускается комплексная атомарная транзакция, в ходе которой:
1) Проверяется, что у клиента в таблице `cash_loan_account` есть актуальный сплит на промоушен. Параметры сплита нужны для создания сессии.
   *Что делать, если у клиента нет сплита на момент принятия награды (возможна ситуация, когда клиент выполняет челлендж но не может получить награду при отсутствии сплита)?*
   *a) Cоздавать на BE сплит на промоушен при его отсутствии*
   *b) Договориться с рисками, чтобы они генерили пре-оффер для клиента (на основе которого будет создаваться сплит) в течение всего срока, пока клиент выполняет промоушен (14 дней) и может забрать награду (7 дней)*
2) Создаем active_pre-offer, объединяется product и pre-offer
3) Создается application
4) Создается session с sequence_id 8 (стандартный флоу ориги)
5) Обновляем сплит, делая его used
6) Обновляем promotion_user делаем его rewarded



Сплитование
- Смотрим на promotion_id, смотрим
- Если в геоконфиге есть флаг, который может отключить промоушены (также работает через админку)
- Нельзя дважды быть новиком: есть проверка, что если текущий оффер клиента с промоушен id, но при этом у клиента нет оффера на обычный флоу?
- Мы смотрим в таблицу promotion_user, где есть статистика по успеху клиента в promotion
- Если клиент был ранее новичком, то мы пускаем клиента по обычному флоу, если у него нет оффера, то он не получит.

  

-- Если клиент стартует промо ,мы делаем запись в promotion_user, достаем pre_offer, смотрим, что у него есть promotion_id, заполняем reward json объект (product_id, pre_approved_amount)

  

-- Есть маппинг promotion_key, promotion_id

  

-- Что происходит при выполнении челленджа (/accept reward)

-- У клиента появляется кнопка - забрать reward

-- FE идет в BE, чтобы создать loan в loan_id (запускается транзакция)



  

-- *также есть ручка /get_reward для просмотра термзов промоушена

  

-- Клиент не нажал на кнопку в течение 7 дней

-- Что будет, если у клиента все еще есть сплит на новичковский promotion? (что он увидит?)

-- Если у клиента нет сплита на новичка, то он просто попадет на обычный лендинг OF (при наличии оффера)

  

-- Что произойдет, если клиент не выполняет promotion

  

-- когда get_reward выполняет ошибку -> показываем окно reward expired

  

-- Окно The challenge is over показывается клиенту, когда он не успел откатать поездки

-- Фронт следит за прогрессом поездок (поллит табличку с прогрессом user_promotion), если клиент увидит user_promotion из статуса EXPIRED (есть ли логика, которая устанавливает этот статус?)

-- Когда приходит событие поездки мы ее процессим (проверяем сумму промоушена), в том числе проверяем, что его промоушен не заэкспайрился.

  
  

-- Вопросы:

-- 1) Что делать, если сплит на новичка пропал (пре-оффер пропал), но при этом клиент выполнил челлендж

-- 2) Что делать, если просрочил принятие reward, но при этом есть сплит новичка (создастся запись на новый промоушен 5/20). Из-за констрейнта на user_id, promotion_id промоушен expired.

-- 3) По какой логике проставляется статус 'EXPIRED' в user_promotion на BE? (вопрос снят).

  

-- Констрейнт не дает возможность пройти промо повторно.



