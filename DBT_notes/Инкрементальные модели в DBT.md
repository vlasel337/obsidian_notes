**Инкрементальная модель** - это [[Модели в DBT|модель]], данные в которой обновляются не целиком, а посредством добавления новых кусочков данных по определенной логике. В DBT для реализации логики инкрементального обновления существует специальный макрос, однако логику обновления должен придумать сам дата-инженер.

Скрипты инкрементальных моделей в DBT содержат две версии кода:
1. первую для инициализирующей загрузки, 
2. вторую - для последующих инкрементальных загрузок.

Чтобы зарегистрировать инкрементальную модель нужно в конфигурации модели в файл `properties.yml` указать свойство `materialized: incremental`.

Пример регистрации инкрементальной модели в конфиге `properties.yml`:
```yml
models:
	- name: "trips_users"
	  description: "Rides enriched with users personal data"
	  config:
		  materialized: "incremental"
```

Существует несколько стратегий [[Стратегии инкрементального обновления DBT|инкрементального обновления моделей]], каждую из которых нужно особым образом регистрировать в конфиге.

Пайплайн материализации инкрементальной модели (для адаптера postgres):
![[Пайплайн материализации инкрементальной модели.png]]

Для указания на то, что модель является инкрементальной через Jinja-блок if/else используется специальный [[Jinja макросы в DBT|макрос]]: `{{ is_incremental() }}`. 
Он работает по принципу флага, который:
- возвращает TRUE, если:
	1) в `properties.yml` есть явное указание на то, что модель инкрементальная:
	   `materialised: incremental`
	2) таблица, описанная моделью, существует в БД, что указывает на то, что это не ее первая материализация
- возвращает FALSE, если:
	1) модель не является инкрементальной, то есть в в `properties.yml` указан другой тип материализации: `materialised: view/table`
	2) таблицы нет в БД, то есть это ее первая материализация
	3) модель запустили с флагом **--full-refresh**, чтобы ее полностью пересоздать

## Полная перезапись инкрементальной модели
Для полного пересоздания инкрементальной модели (инициализирующей загрузки) используется флаг **--full-refresh**:
`dbt run -s trips_users --full-refresh`
*(Команду строго не рекомендуется использовать без селектора -s)*

Для ограничения использования этого опасного флага можно в конфигурационный файл properties.yml добавить ограничение: `full_refresh: false`. При добавление данного ограничения флаг перестанет работать. Если все же понадобится пересоздать инкрементальную модель с нуля, то можно убрать эту строчку из конфигурационного файла модели.