Внешние пакеты (**packages**) для DBT содержат готовую бизнес-логику (тесты, макросы), которую можно переиспользовать в проекте. 

Пакеты DBT можно найти на специализированном ресурсе [dbt Hub](https://hub.getdbt.com/).

Внешние пакеты добавляются в формате: `имя_автора/имя_пакета` через файл `dependencies.yml`, расположенный в корне проекта:
```yml
packages: 
	- package: dbt-labs/dbt_utils 
	  version: 1.3.0
```

Для подключения пакетов из файла `dependencies.yml` можно воспользоваться командой:
`dbt deps`

Запуск этой команды:
1. Создает в корне проекта папку `dbt_packages`, в которой хранятся все подключенные внешние пакеты (ее нужно добавить в `.gitignore`, чтобы не перегружать репозиторий).
2. Создает в корне проекта файл `packages-lock.yml`, в котором перечислены все установленные пакеты с их версиями и контрольными суммами.

Перед деплоем проекта с внешней зависимостью на удаленный сервер необходимо сообщить ему в файле `deploy_docs.yml`, что в проекте используются внешние зависимости:
```yml
- name: Install requirements 
  run: | 
	  pip install -r requirements.txt 
	  dbt deps
```

При создании [[Каталог данных в DBT|каталога данных]] для проекта с внешним пакетом внешний пакет будет отображаться в левой панели каталога:
![[DBT External packages.png|200]]

# Пакет dbt_utils
Один из самых популярных внешних пакетов dbt, который содержит множество тестов и макросов: [dbt_utils](https://hub.getdbt.com/dbt-labs/dbt_utils/latest/).

Так, например, в пакете содержится [[Макросы в DBT|макрос]] `pivot`, который позволяет реализовывать логику разворачивания столбцов, как в сводных таблицах:
```sql
select
	age,
	{{ dbt_utils.pivot("sex", ["M","F"]) }}
from {{ ref("trips_users") }}
group by age
order by age
```

Также пакет содержит множество [[Тесты в DBT#Обобщенные тесты (дженерики)|дженерик тестов]]. В качестве примера можно рассмотреть тест `not_constant`, который проверяет, что в колонке содержатся разнородные значения (более одного уникального значения):
```yml
model:
	- name: "sex_age_pivot"
	  description: "Trips per age pivoted by sex"
	  data_tests:
		  - unique_key:
			    columns: [ "age" ]
	  columns:
		  - name: "age"
		    description: "Numerical age of user"
		    data_tests:
			    - "dbt_utils.not_constant"
```





