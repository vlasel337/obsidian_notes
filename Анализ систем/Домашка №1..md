# Event Storming
Ссылка на Miro борду со схемой Event Storming: https://miro.com/app/board/uXjVJ6nwoJA=/?share_link_id=510406771189

Пояснения для понимания схемы:
- **Голубые стикеры с командами** размещал **поверх** стикеров с событиями, чтобы контексты не расползались в длинные колбасы.
- Слова "услуга", "задача" и "заказ" являются синонимами в описываемой схеме.
  "Эталонный образец" и "клиент", а также "обычный образец" и "воркер", "менеджер" и "сотрудник отдела контроля качества" также являются синонимами. 
  В будущем стоит договориться об унификации терминов во избежание разночтений.
- Стикеры внутри контекстов расположены в хронологическом порядке. Сами контексты расположены относительно друг друга не в хронологическом порядке, а чисто по наитию.

## Контексты и их обоснования
В процессе Event Storming по требованиям к системе у меня получилось выделить 7 контекстов:
1. клиентов,
2. воркеров,
3. менеджеры,
4. алгоритм матчинга,
5. снабжение,
6. модуль оплаты,
7. дэшборд.

Далее описываю причины выделения каждого из контекстов.

### 1. Контекст клиентов
В рамках этого контекста клиент:
- проходит аутентификацию,
- указывает свои дополнительные ПД, предпочтения и способ оплаты,
- создает заказы на выполнение услуг,
- легитимизирует факт завершения заказа своей подписью.

За заказы внутри неделе придется заплатить. Это обстоятельство связывает контекст клиентов с контекстом системы оплаты.

### 2. Контекст воркеров
В рамках этого контекста воркер:
- проходит тестирование для подтверждения уровня профессионализма,
- объявляет о своем желании взяться за заказ,
- запрашивает и получает необходимые расходники,
- выполняет заказ и отчитывается о его результатах.

В результате своих телодвижений воркер должен будет получить денежные средсва, что заставит систему обратиться к контексту системы оплаты.

### 3. Контекст менеджеров
Менеджеров и отдел контроля качества разделять не стал, так как, принимая во внимание потенциальную нагрузку, кажется, что их функционал могут выполнять одни и те же сотрудники.

У менеджеров много направлений деятельности, но все они не особо масштабные:
- назначение тестов и их кастомизация,
- конфигурация услуг,
- контроль качества,
- опциональное начисление средств,
- возможность совершения ставок.

Информация о возможных зачислениях со стороны менеджеров в пользу работников должна поступать из менеджерского контекста в контекст платежной системы. Однако эту информацию будет обрабатывать не какой-то отдельный актор, а уже существующий актор – ежемесячная крона, которая будет учитывать менеджерские зачисления при выставлении инвойса (нет требования, что менеджерские зачисления должны проводиться в особом порядке).

Касательно функционала ставок, из контекста менеджеров в контекст платежной системы должны идти уведомления о совершенных ставках для того, чтобы платежная система рассчитывала выигрыш для победителя.

### 4. Контекст алгоритма матчинга
В этом контексте происходит связь воркеров с задачами.
Алгоритм матчинга однозначно стоит выделять в отдельный контекст, так как им явно будут заниматься отдельные разработчики в кооперации с ML-специалистами. 

Тем более в требованиях указано, что этот алгоритм является уникальной ценностью компании, выделяющей ее на фоне конкурентов.

Возможно в этом контексте потребуется специфичный уровень конфиденциальности, связанный с коммерческой тайной.

### 5. Контекст снабжения
В контекст снабжения добавил взаимодействие с внешним подрядчиком, занимающимся печеньями. Этот контекст достаточно тривиальный. В нем по уведомлению происходит подготовка расходников и печенья, также по уведомлению происходит их выдача.

### 6. Контекст модуля оплаты
Внутри модуля оплаты будет реализованы три процесса:
1. Еженедельное списание средств у клиентов
2. Ежемесячное зачисление средств воркерам (с учетом процента, штрафов, начислений от менеджеров).
3. Процесс расчета выигрыша по ставкам, который будет триггериться изменениями статуса заказов.

Из контекста модуля оплаты будет происходить обращение к внешним платежным системам, в том числе и к Золотой Шляпе.

### 7. Контекст дэшборда
Честно говоря, я сомневаюсь, что выделять дэшборд в отдельный контекст – верное решение, но намеренно допускаю его, так как не могу придумать куда и как изящно распихать требования инкапсулированные внутри него. Подозреваю, что их можно раскидать по контекстам клиентов и воркеров. 

Вполне возможно, что под дэшбордом будет БД, в которой будут храниться данные о всех завершенные заказах, израсходованном инвентаре, проведенных инвойсах, платежах и прочая историческая информация. Именно поэтому я добавил стрелки от других контекстов к контексту дэшборда, чтобы подчеркнуть, что они будут делиться с ним данными.

# Модель данных
Ссылка на LucidChart с концептуальной моделью данных (нужно будет залогиниться/на всякий случай прилагаю картинку):
https://lucid.app/lucidchart/2970c632-309b-4316-8ae4-7b77ab634f4a/edit?invitationId=inv_759a1e7a-b618-4795-a082-510f715da9f9


При создании модели данных я перенес контексты, полученные в результате Event Storming. Добавил в контексты данные, которые фигурируют в каждом из контекстов. 

Что касается владельцев данных, то получилась следующее:
- Владельцем заявки на заказ услуги (**request for service order**) является контекст клиентов. Заказ (**service order**) на услугу происходит из заявки на заказ.
- Владельцем данных о **service order** является контекст матчинга, который для создания **service order** использует данные о **client**, **worker**, **request for service order** и **archived orders**.
- Контекст воркеров является владельцем данных о результатах тестирования (**test result**) и результатах выполнения заказов (**service order result**).
- Контекст менеджеров является владельцем данных о тестах (**test**), ставках (**bet**), отчетах по качеству (**quality report**), штрафах (**fine**).
- Контекст снабжения потребляет данные о созданных **service order** и под каждый из них формирует **inventory pack** с печенькой, о готовности которого сообщается в контекст воркера.
- Контекст модуля оплаты является владельцем данных об инвойсах (**invoice**) и платежах (**payment**). В свою очередь он потребляет информацию о заказах (**service order**), воркерах (**worker**), клиентах (**client**), менеджерах (**manager**), ставках (**bet**).
- Контекст дэшборда по сути является владельцем архивных данных о заказах, платежах, ставках, паков с расходниками и всех прочих сущностях и связан со всеми контекстами. Он представляет из себя что-то вроде кросс-контекстного DWH.

Постарался сделать схему максимально простой, чтобы она сохраняла наглядность, но понимаю, что количество стрелок негативно сказывается на понимании.

# Коммуникации
По коммуникациям получилось так, что все коммуникации внутри контекстов получились синхронными, а практически все коммуникации между контекстами – асинхронными. Так получилось из-за отсутствия необходимости в максимально быстром реагировании на результаты событий: проверка результатов тестов, подбор воркера на задачу, сбор расходников под заказ, расчет ставки могут происходить в фоновом режиме, а оплата производится раз в неделю/месяц.

# Обоснование выбранной структуры
В целом я не считаю, что выбор между монолитом и микросервисами обязательно должен быть взаимоисключающим. 

В этой связи основную часть бизнес логики с клиентским, воркерским, менеджерским и флоу а также дэшборд я бы реализовал в монолите.

Контексты модуля оплаты, модуля снабжения и модуля мэтчинга воркеров с задачами я бы вынес в отдельные сервисы, так как считаю, что это отдельные независимые функции системы, с которыми можно безболезненно реализовать асинхронные коммуникации (+ не было требований по скорости поиска воркера на заказ, скорости исполнения заказов, скорости подбора расходников, скорости зачисления средств). 




