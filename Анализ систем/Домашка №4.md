Ссылка на Miro-борду с решением: https://miro.com/app/board/uXjVJ6nwoJA=/
В качестве системы для рефакторинга я выбрал систему предложенную в pdf-файле.

Сперва отразил систему "AS IS" с указанием instability всех элементов, а затем показал систему "TO BE", которая должна получиться после рефакторинга. 


# Рефакторинг боундед-контекстов
Я выделил 3 элемента системы, которые нуждаются в рефакторинге:
1. Вынесение боундед-контекста матчинга сотрудников и клиентов в отдельный сервис.
2. Упразднение отдельного энтити-сервиса воркеров, добавление контекста воркеров в сервис скоринга работников.
3. Разделение сервиса расчета и списания средств у клиентов и сотрудников на два отдельных сервиса.

### 1. Вынесение боундед-контекста матчинга сотрудников и клиентов в отдельный сервис.
Решение об изменении типа данного поддомена на core и вынесении данного боундед-контекста в отдельный сервис принято ввиду отличия архитектурных характеристик поддомена:
- Deployability, Agility, Testability – выше, чем стандартно в системе,
- Security – необходим для того, чтобы алгоритм матчинга оставался коммерческой тайной,
- Modifiability – необходим, так как есть требование о возможности регулярного внесения корректировок в алгоритм,
- Scalability, Elasticity – необходим для того, чтобы сервис справлялся с нагрузкой, была возможность ее увеличения.

Вынесение боундед-контекста матчинга в новый сервис будет сопровождаться изменением архитектурного стиля (выбор в сторону pipeline), а также изменением типа БД (выбор в пользу графовой БД). В этой связи для вынесения данного контекста в отдельный сервис будет выбрана стратегия **data first: change data capture**.

Выбранная стратегия обеспечит более скорую интеграцию нового сервиса и запуск его в эксплуатацию.
### 2. Упразднение отдельного энтити-сервиса воркеров, добавление контекста воркеров в сервис скоринга работников.
Отдельный энтити-сервис порождает большую instability в системе. Любое изменение в одном из сервисов, с которым связан энтити-сервис, приведет к тому, что энтити сервис упадет, а за ним по цепочке и все остальные сервисы, связанные с ним. Такая опасная зависимость объясняется тем, что энтити-сервис связан с другими сервисом через синхронные связи.

В целевой картине энтити-сервис будет упразднен, а функциональность его боундед-контекста включена в сервис скоринга работников, так как именно этот поддомен является оунером данных о воркерах и именно он мутирует данные о них. 

Данные о воркерах будут стримиться в систему, откуда её будут асинхронно забирать все сервисы, которые пользуются информацией о воркерах.

### 3. Разделение сервиса расчета и списания средств у клиентов и сотрудников на два отдельных сервиса.
Решение о разделении данного сервиса (и боундед-контекста) на два отдельных обсуловлено тем, что механики расчета и списания средств для клиентов и сотрудников могут в будущем разойтись настолько сильно, что код будет невозможно поддерживать из-за большого количества ветвлений.

Для реализации декомпозиции одного сервиса на два будет использована стратегия **code first: tactical forking**, так как совокупная функциональность новых сервисов не будет отличаться от функциональности старого.

В результате такого решения:
- не изменится глобальная сложность системы, потому что между поддоменами не будет связанности;
- будет легко поддерживать и изменять функционал, если каждый из способов расчёта зарплаты из отдельного поддомена будет развиваться в своём направлении; 
- не придется переписывать уже существующую логику.

# Оценка instability
Расчеты instability приведены на Miro борде: https://miro.com/app/board/uXjVJ6nwoJA=/

Желтым выделял instability сервисов, которые подверглись изменениям в ходе рефакторинга.

Я не понял как правильно считать instability (нужно ли учитывать асинхронные связи в подсчете или все-таки нет), потому что я по всей видимости рассчитал ее неправильно. У меня получилось так, что instability критичных элементов системы (сервиса скоринга и сервиса планирования визита) только возросла. Как будто бы это должно указывать на то, что рефакторинг неудачный, но я не чувствую, что сделал ошибки при принятии архитектурных решений, так как отзеркалил то, что было в уроке.

# План работ по рефакторингу

### 1. Есть ресурсы, нет инфраструктура и экспертизы
В ситуации наличия ресурсов и отсутствия экспертизы/инфраструктуры я бы запланировал работы по рефакторингу в таком порядке:
1. **Разделение сервиса расчета и списания средств у клиентов и сотрудников на два отдельных сервиса.** Это самая простая с технической точки зрения часть рефакторинга, с которой можно начать. Архитектурные характеристики нового сервиса на первых порах не будут отличаться от характеристик старого сервиса. Подход tactical forking позволит быстро поднять новый сервис. При реализации данного пункта команда сможет набраться экспертизы + будет развернута необходимая инфраструктура.
2. **Разделение сервиса расчета и списания средств у клиентов и сотрудников на два отдельных сервиса.** Эта задача куда более комплексная и с более высоким уровнем неопределенности (будут использоваться новые технологии), чем предыдущая, так как помимо вынесения функциональности в отдельный сервис, необходимо будет изменить стиль сервиса и выбрать новый тип БД. Тем не менее задача достаточно хорошо очерчена и локализована, количесво связей в системе существенно не изменится.
3. **Упразднение отдельного энтити-сервиса воркеров, добавление контекста воркеров в сервис скоринга работников.** Эта задача наиболее технически сложная, так как энтити-сервис воркеров обладает высоким instability и при этом связан с большим количеством элементов системы (имеет высокий coupling). Задача по его рефакторингу будет состоять из 2-х шагов: 1) Перенесение боундед-контекста в сервис скоринга и настройка стриминга, 2) Переключение на стриминговые данные и деприкация старого энтити-сервиса.

### 2. Есть инфраструктура и экспертиза, но нет ресурсов
Если в команде есть экспертиза и инфраструктура, но нет ресурсов, то план работ по рефакторингу будет строго противоположный:
1. Начнем с наиболее сложной задачи по упразднению энтити-сервиса;
2. Затем приступим к вынесению алгоритма матчинга в отдельный сервис;
3. Завершим работы разделением сервиса оплаты на два отдельных сервиса.

Допускаю, что ранжирование уровня сложности задач по выделению отдельного сервиса матчинга и деприкации энтити-сервиса воркеров может варьироваться. Проранжировал их сложность субъективно (по чуйке).


