Этап расчета нагрузки логично вытекает из этапа [[Сбор требований к системе|сбора требований к системе]].

Общая нагрузка на систему складывается из нагрузки на ее компоненты:
![[System components.png]]
1. **Пользовательская нагрузка**. Необходимо оценить какое количество пользователей будет пользоваться системой в день/месяц, какое может быть максимальное количество одновременных пользователей, какое будет соотношение чтения к записи R/W. 
2. **Сетевая нагрузка**. Нужно понимать сколько одновременных соединений нужно будет удерживать с сервером системы.
3. **Вычислительная нагрузка на сервисы**. Нужно прикинуть сколько потребуется инстансов системы, какое количество серверов потребуется и какая у них должна быть конфигурация. Реальную нагрузку можно оценить путем проведения нагрузочного тестирования.
4. **Нагрузка на хранилище**. Важно понимать какое количество файлов какого размера будут загружать пользователи, чтобы оценить необходимый объем хранилища (облачного или физического) и скорость увелич ения объема данных.

Основная задача процесса расчета нагрузки - понять **хватит ли денег** на реализацию системы на инфраструктурном уровне. В идеале в результате расчета нагрузки на систему нужно прикинуть сколько серверов потребуется на ее реализацию и какова будет их **общая стоимость** (для простых сервисов по типу сокращателя ссылок как правило достаточно одной машины).

# Пользовательская нагрузка
При расчете пользовательской нагрузки на систему необходимо оценить:
- количество пользователей будет регулярно пользоваться системой: **MAU**, **DAU**;
- общее количество пользователей за контрольный период (например, 5 лет)
  \**важно, если мы храним данные о пользователях*;
- количество контента, которое в среднем будет производить/считывать один клиент;
- среднее количество контента произведенное пользователем в день;
- будет ли перекос нагрузки в сторону чтения или в сторону записи **R/W**;
- будет ли какой-то перекос в нагрузке в зависимости от сезона/времени суток/дня недели.

В результате оценки параметров выше можно прикинуть:
- максимальное число запросов в секунду (**RPS**) к различным частям сервиса;
- количество одновременных соединений с сервером, которое нужно будет удерживать:
  `Число соединений = RPS × Среднее время обработки одного запроса (в секундах)`
  (если пользователи делают 1000 RPS, но каждый запрос обрабатывается 100 миллисекунд, то необходимо удерживать одновременно 1000 * 0,1 = 100 соединений);
- приращение занимаемого места в хранилище;
- стоимость обслуживания трафика и затраты на железо.

Переменные, которые должны приходить извне (от заказчика):
- количество ежедневных/ежемесячных пользователей;
- количество целевых действий пользователей (создания постов, просмотр сообщений);
- средний вес одной записи от пользователя.
 
# Сетевая нагрузка
Сетевая нагрузка делится на две категории:
1. Количество удерживаемых соединений (сколько запросов обрабатывается одновременно). 
2. Объем сетевого трафика.

### Ограничения по количеству удерживаемых соединений
Количество сетевых соединенений, которое нужно поддерживать одновременно, вычисляется по формуле:
`Число соединений = RPS × Среднее время обработки одного запроса (в секундах)`

Современные сервера позволяют без проблем в рамках одного инстанса удерживать **10-100 тысяч соединений**.  

### Ограничения по сетевому трафику
Для того, чтобы оценить сетевой трафик необходимо понять сколько данных в день/минуту/секунду передают пользователи.

Обычно средняя скорость соединение между клиентами и облачными инстансами составляет **1 GbE**. Если речь идет о соединении между железными сервисами, то скорость соединения между ними может достигать **10(медные кабели)/40 (оптоволокно)/100(Infiniband технологии) GbE/секунду**

Стоимость сетевого трафика составляет от **$0.01** (например, внутри одного региона) до **$0.1** (например, между континентами) **за 1 GB**  трафика.

# Вычислительная нагрузка
Вычислительную нагрузку оценить сложнее всего.

Ее приблизительные значения можно прикинуть изучив открытые данные по замерам нагрузки на разных фреймворках и **облачных** инстансах.  

Так, например, для популярного фреймворка (например, Flask) один усредненный облачный инстанс будет выдавать такие показатели:
- **до 100k RPS** для простых запросов текстовых данных;
- **до 10k RPS** для запросов на чтение из БД;
- **до 1k RPS** для запросов на запись в БД.

Для необлачных инстансов, находящихся на **физических серверах** такие показатели будут выше (ориентировочно в 5 раз).

Для фреймворка находящегося на физическом сервере показатели будут такими:
- **до 500k RPS** для простых запросов текстовых данных;
- **до 50k RPS** для запросов на чтение из БД;
- **до 5k RPS** для запросов на запись в БД.
# Нагрузка на хранилище
При оценке нагрузки на хранилище важно понять:
- сколько контента ежедневно генерируют пользователи 
- и какой средний вес этого контента. 

Исходя из этих вводных можно прикинуть сколько места в БД потребуется для сохранения пользовательского контента и какой ожидается его постоянный прирост.

Существует несколько популярных типов железных хранилищ данных:
1. **HDD** (Hard Disk Drive) - для хранения долговременной информации, к которой сервисы обращаются редко.
2. **SSD** (Solid State Drive) - для хранения чувствительной информации, которую нужно получать быстрее и регулярнее, чем с жесткого диска.
3. **RAM** (Random Access Memory) - для хранения супер актуальной информации (например, кэш).

| Тип                                     | Скорость чтения/записи | Максимальная емкость | Средняя стоимость  |
| --------------------------------------- | ---------------------- | -------------------- | ------------------ |
| Жесткий диск (**HDD**)                  | до 300 Mb/секунду      | до 20 TB             | до $500            |
| Твердотельный NVMe накопитель (**SSD**) | до 3-5 GB/секунду      | до 8 TB              | до $2000           |
| Оперативная память (**RAM**)            | до 50 GB/секунду       | 128 GB за планку     | до $1000 за планку |

Таким образом средняя стоимость хранения **1TB** на разных накопителях составит:
- HDD: $30
- SSD: $300
- RAM: $10000

Один сервер, как правило, состоит из 1TB RAM, 50 TB SSD, 200 TB HDD (+ стоит заложить, что за год выходит из строя 1% от количества HDD, установленных на серверах).

# Примеры оценки нагрузки
Вводные:
- В сервис будет осуществляться 1 миллион загрузок текстов в день (в среднем по 2 загрузки на пользователя). Таким образом **DAU** = 1 млн/2 = 500к, **MAU** составит 10 млн.
- Соотношение чтения к записи R/W = 10/1.
- Каждая запись будет помещаться в 10 KB (текст на ~5000 символов).

Количество обращений на чтение к сервису в месяц составит: 
`30 дней в месяце × 500к DAU × 20 чтений в день = 30 млн`

Нагрузка на создание записей составит:
`1 миллион в день / 10000 секунд (в дне 86400 сек.) = 10 RPS`

Нагрузка на чтение составит:
`10 × 10 (cоотношение чтений к записям) = 100 RPS`

При учете того, что средний размер записи будет помещаться в 10 KB, мы будем генерировать трафик до 1MB/s или 8Mb/s.

На горизонте 5 лет сервис будет хранить в себе:
`5 лет × 12 месяцев × 30 млн записей в месяц = 2 миллиарда записей`
Что при учете веса одной записи 10 KB займет:
`2 млрд записей × 10 = 20 TB`





