**Диаграмма C4** – это методология описания архитектуры системы в разных масштабах (в четырех приближениях), как в Google Maps: от карты мира до карты страны, города, улицы.

В рамках методологии C4 выделяют 4 уровня описания системы:
1. **Context diagram (Контекстная диаграмма)**. Высокий уровень, где система отражается, как "черный ящик" в окружении других систем, с которыми она взаимодействует.
2. **Container diagram (Контейнерная диаграмма)**. На этом уровне рассматривается из каких компонентов состоит система (приложения, базы, сервисы, брокеры сообщений).
3. **Component diagram (Компонентная диаграмма)**. Как устроены внутренности каждого из отдельных модулей системы (FE, BE, БД).
4. **Code diagram (Диаграмма кода)**. На этом уровне описываются низкоуровневые детали реализации компонентов системы (например, классы, модули).

Пример C4 диаграммы (контекстный и контейнерный уровни):
```plantuml
@startuml inFleet Service

!include <c4/C4_Container.puml>

  

!define ICONS https://raw.githubusercontent.com/tupadr3/plantuml-icon-font-sprites/v2.4.0

!include ICONS/devicons/mysql.puml

!include ICONS/devicons2/go.puml

  

!define EXTRA https://raw.githubusercontent.com/plantuml-stdlib/gilbarbara-plantuml-sprites/v1.1/sprites

!include EXTRA/envoy-icon.puml

  
  

AddElementTag("planned", $bgColor="#AA4444")

AddRelTag("wrong", $lineColor="red", $textColor="red")

AddRelTag("planned", $lineStyle=DashedLine(), $textColor="blue")

AddElementTag("provider_ext", $bgColor="green")

  

title Container diagram for Registration Service

  

System_Ext(in_fleet_cloudfront, "AWS Cloudfront Distribution", "service.public.address", $tags="global")

  

Boundary(inDrive, "inDrive company") {

Boundary(neobank_loan_instance, "Registration Service") {

System_Boundary(neobank_loan_service, "Registration Service") {

Container(registration_go_service, "Registraion Service", "Go application", "Manages the loan application process", "go", $tags="regional+latam-mx+latam-co")

  

Boundary(infra, "Infrastructure layer") {

SetPropertyHeader("Table", "Description")

AddProperty("Policy", "steps properties")

AddProperty("State", "user state")

AddProperty("Data", "application data & partner's interactions")

AddProperty("Profile", "verified data")

ContainerDb(registration_database, "Database", "DynamoDB", "Stores origination data", "nosql", $tags="regional")

Rel_R(registration_go_service, registration_database, "Reads and writes to", "HTTP")

}

  

Container(in_fleet_service_ingress, "Envoy Public Gateway", "Envoy (service.public.address)", "K8s Gateway", "envoy-icon", $tags="regional+latam-mx+latam-co")

Rel(in_fleet_cloudfront, in_fleet_service_ingress, " ", "HTTP")

Rel(in_fleet_service_ingress, registration_go_service, " ", "HTTP")

  

}

  

' SetPropertyHeader("Topic", "Source", "Type")

' AddProperty("new-order.rides.v1.prod", "Finished rides from New Order", "Regional")

' AddProperty("new-order.contractors-order-receipt-info.v1.prod", "Driver commission amounts", "Regional")

' AddProperty("Credit-card.vehicles.v1.prod", "Notification about user's active vehicle update", "Regional")

' AddProperty("in-fleet.ride.event.v1.prod", "Brief information about user rides performed using rented vehicle", "Regional")

' AddProperty("in-fleet.rental.event.v1.prod", "Events related to rentals updates", "Regional")

' AddProperty("user-termination.deactivate.request-approvals.v1.prod", "Broadcast request to collect approvals from approver services", "Global (Replicated)")

' AddProperty("user-termination.delete.collect-pi-details.v1.prod", "Broadcast request to collect information on the presence and types of personal data", "Global (Replicated)")

' AddProperty("user-termination.delete.request-delete-pi.v1.prod", "Send individual deletion tasks to specific services", "Global (Replicated)")

' AddProperty("user-termination.deactivate.success.v1.prod", "Notification of successful user deactivation", "Global (Replicated)")

' ContainerQueue(kafka, "Message Broker", "Apache Kafka (kafka-messaging-all-broker.kafka-messaging.svc.cluster.local)")

' Rel(registration_go_service, kafka, "Consumes events", "new-order.rides.v1.prod, new-order.contractors-order-receipt-info.v1.prod, garage.vehicles.v1.prod, user-termination.deactivate.request-approvals.v1.prod, user-termination.delete.collect-pi-details.v1.prod, user-termination.delete.request-delete-pi.v1.prod, user-termination.deactivate.success.v1.prod")

' Rel(registration_go_service, kafka, "Produces events", "in-fleet.ride.event.v1.prod, in-fleet.rental.event.v1.prod")

  

System_Ext(prometheus, "Prometheus", "Metrics collector", $tags="regional")

Rel(prometheus, in_fleet_service_ingress, "Scraps app metrics", "GET /metrics", "HTTP")

  

' System_Ext(partner_webhook_service, "Partner Webhook Service", "Pushes events from inDrive infrastructure to partners", $link="", $tags="regional")

' Rel(partner_webhook_service, kafka, "Consumes events", "in-fleet.ride.event.v1.prod")

  

' System_Ext(watchdocs_service, "WatchDocs Service", "Controls and handles documents", $link="../watchdocs-2/container.puml", $tags="regional+linked")

' Rel(registration_go_service, watchdocs_service, "Get user document details on demand, create applications for partner transport", "gRPC")

  
  

}

System_Ext(credit_card_service, "Credit-card Service", "Loan managenet service", $link="../garage/system.puml", $tags="regional")

' Rel(credit_card_service, kafka, "Provide notification of user vehicle changes", "garage.vehicles.v1.prod")

Rel(credit_card_service, registration_go_service, "Initiates registration process", "gRPC")

Rel_U(registration_go_service, credit_card_service, "Manages a loan created in registration service", "gRPC")

  

System_Ext(n8n, "N8N", "Decision making system", $tags="regional+latam-mx+latam-co")

Rel_U(registration_go_service, n8n, "Initiates async checks", "HTTP")

Rel(n8n, registration_go_service, "Sends checks results", "HTTP")

' System_Ext(user_termination, "User Termination Service", "Provides user account deactivation functions (user-termination-grpc.prod.euce1.aws.indrive.tech)", "", $link="./system/user-termination/system.puml", $tags="linked+global+euce1")

' Rel(user_termination, kafka, "Produces event for Approver and Data Holder roles", "user-termination.deactivate.request-approvals.v1.prod, user-termination.delete.collect-pi-details.v1.prod, user-termination.delete.request-delete-pi.v1.prod, user-termination.deactivate.success.v1.prod")

' Rel(registration_go_service, user_termination, "Report personal about collected personal data and deletion task status", "gRPC")

}

  

Boundary(ext_services, "External Services") {

together {

System_Ext(SEON, "SEON", "AML")

' Rel_U(SEON, in_fleet_cloudfront, "Manage transport and rentals", "HTTP")

Rel(registration_go_service, SEON, "Process AML checks (PEP, sanctions)", "HTTP")

  

System_Ext(sumsub, "Sumsub", "KYC")

Rel(registration_go_service, sumsub, "Process KYC checks (liveness, personal docs)", "HTTP")

  

System_Ext(cdc, "CDC", "Credit History Bureau")

Rel(registration_go_service, cdc, "Process KYC checks (liveness, personal docs)", "HTTP")

  

System_Ext(belvo, "Belvo", "Penny Validation")

Rel(registration_go_service, belvo, "Checks bank details reliability", "HTTP")

}

}
@enduml
```


